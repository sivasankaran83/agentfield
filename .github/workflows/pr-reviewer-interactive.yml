name: PR Reviewer Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  pr-review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@pr-reviewer') &&
       github.event.issue.pull_request)
    
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        
      
      - name: ðŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: ðŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl jq
      
      - name: ðŸ“š Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Install PR Reviewer dependencies
          if [ -f .pr-reviewer/requirements.txt ]; then
            pip install -r .pr-reviewer/requirements.txt
          fi
      
      - name: ðŸ—ï¸ Install AgentField
        run: |
            echo "ðŸ“¥ Installing AgentField CLI.."
            cd .pr-reviewer
            curl -sSf https://agentfield.ai/get | bash
            echo "$HOME/.agentfield/bin" >> $GITHUB_PATH
            export PATH="$HOME/.agentfield/bin:$PATH"
            af server &        

      - name: ðŸ“ Create Working Directories
        run: |
          mkdir -p .pr-reviewer/logs
          mkdir -p .pr-reviewer/results
      
      - name: ðŸš€ Verifying AgentField
        run: |
          af --version
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… AgentField is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          if ! curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo "âŒ AgentField failed to start"
            cat ../../logs/agentfield.log
            exit 1
          fi
        env:
          AGENTFIELD_SERVER: http://localhost:8080
      
      - name: ðŸ¤– Start PR Reviewer Agents
        run: |
          echo "Current workspace: ${{ github.workspace }}"
          cd ${{ github.workspace }}
          echo "Parent directory: $(pwd)"
          BASE_DIR="$(pwd)/.pr-reviewer"
          if [ ! -f "$BASE_DIR/agents/planner_agent.py" ]; then
            echo "Error: planner_agent.py not found at $BASE_DIR/agents/"
            exit 1
          fi
          echo "Starting agents..."

          # Set PYTHONPATH to include .pr-reviewer directory for module imports
          export PYTHONPATH="$BASE_DIR:$PYTHONPATH"
          echo "PYTHONPATH set to: $PYTHONPATH"

          # Start each agent in background
          python "$BASE_DIR/agents/summarization_agent.py" > "$BASE_DIR/logs/summarizer.log" 2>&1 &
          sleep 2

          python "$BASE_DIR/agents/planner_agent.py" > "$BASE_DIR/logs/planner.log" 2>&1 &
          sleep 2

          python "$BASE_DIR/agents/executor_agent.py" > "$BASE_DIR/logs/executor.log" 2>&1 &
          sleep 2

          python "$BASE_DIR/agents/verifier_agent.py" > "$BASE_DIR/logs/verifier.log" 2>&1 &
          sleep 2

          python "$BASE_DIR/agents/generator_agent.py" > "$BASE_DIR/logs/generator.log" 2>&1 &
          sleep 5

          # Verify agents registered with AgentField
          agent_count=$(curl -s http://localhost:8080/agents 2>/dev/null | jq '. | length' || echo "0")
          echo "Registered agents: $agent_count"

          if [ "$agent_count" -lt "5" ]; then
            echo "âš ï¸ Warning: Only $agent_count/5 agents registered"
            echo "Continuing anyway..."
          else
            echo "âœ… All 5 agents registered successfully!"
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AGENTFIELD_SERVER: http://localhost:8080
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” Parse Command
        id: parse_command
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "action=analyze" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer proceed"* ]]; then
            echo "action=proceed" >> $GITHUB_OUTPUT
            # Extract context after "proceed"
            context=$(echo '${{ github.event.comment.body }}' | sed 's/.*@pr-reviewer proceed//g' | xargs)
            echo "context=$context" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer execute"* ]]; then
            echo "action=execute" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer merge"* ]]; then
            echo "action=merge" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer rollback"* ]]; then
            echo "action=rollback" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          else
            echo "action=none" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ”¬ Run PR Review Workflow
        if: steps.parse_command.outputs.action != 'none'
        working-directory: .pr-reviewer
        run: |
          export PYTHONPATH="${{ github.workspace }}/.pr-reviewer:$PYTHONPATH"
          python scripts/github_workflow_runner.py \
            --pr-number ${{ github.event.pull_request.number || github.event.issue.number }} \
            --action ${{ steps.parse_command.outputs.action }} \
            --repo ${{ github.repository }} \
            --context "${{ steps.parse_command.outputs.context }}"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AGENTFIELD_SERVER: http://localhost:8080
      
      - name: ðŸ“Š Upload Agent Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.run_number }}
          path: |
            .pr-reviewer/logs/
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“Š Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-results-${{ github.run_number }}
          path: |
            .pr-reviewer/results/
            .pr-reviewer/*.json
          retention-days: 7
          if-no-files-found: ignore