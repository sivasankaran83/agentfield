name: PR Reviewer Agent

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  pr-review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '@pr-reviewer') &&
       github.event.issue.pull_request)
    
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}
      
      - name: ðŸ‘©ðŸ»â€ðŸ’» Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
        
      
      - name: ðŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: ðŸ“¦ Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl jq
      
      - name: ðŸ“š Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Install PR Reviewer dependencies
          if [ -f .pr-reviewer/requirements.txt ]; then
            pip install -r .pr-reviewer/requirements.txt
          fi
      
      - name: â˜¸ï¸ Install AgentField
        run: |
            echo "ðŸ“¥ Installing AgentField CLI.."
            curl -sSf https://agentfield.ai/get | bash
            echo "$HOME/.agentfield/bin" >> $GITHUB_PATH

      - name: ðŸ“ Create Working Directories
        run: |
          mkdir -p .pr-reviewer/logs
          mkdir -p .pr-reviewer/results

      - name: ðŸš€ Start AgentField Server
        run: |
          export PATH="$HOME/.agentfield/bin:$PATH"
          af --version

          # Start server in background with output redirect
          nohup af server > .pr-reviewer/logs/agentfield-server.log 2>&1 &
          SERVER_PID=$!
          echo "AgentField server started with PID: $SERVER_PID"
          echo $SERVER_PID > .pr-reviewer/agentfield.pid

          # Wait for server to be healthy
          echo "Waiting for AgentField to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… AgentField is ready!"
              exit 0
            fi
            echo "Attempt $i/30: Server not ready yet..."
            sleep 2
          done

          # Server failed to start
          echo "âŒ AgentField failed to start within 60 seconds"
          if [ -f .pr-reviewer/logs/agentfield-server.log ]; then
            echo "=== Server logs ==="
            cat .pr-reviewer/logs/agentfield-server.log
          fi
          exit 1
        env:
          AGENTFIELD_SERVER: http://localhost:8080
      
      - name: ðŸ‘·ðŸ½â€â™‚ï¸ Start PR Reviewer Agents
        run: |
          echo "Current workspace: ${{ github.workspace }}"
          cd ${{ github.workspace }}
          echo "Parent directory: $(pwd)"
          BASE_DIR="$(pwd)/.pr-reviewer"

          # Verify agent files exist
          if [ ! -f "$BASE_DIR/agents/planner_agent.py" ]; then
            echo "âŒ Error: planner_agent.py not found at $BASE_DIR/agents/"
            exit 1
          fi

          echo "Starting agents..."

          # Set PYTHONPATH to include .pr-reviewer directory for module imports
          export PYTHONPATH="$BASE_DIR:$PYTHONPATH"
          export PATH="$HOME/.agentfield/bin:$PATH"
          echo "PYTHONPATH set to: $PYTHONPATH"

          # Verify AgentField is still healthy
          if ! curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo "âŒ AgentField server is not healthy before starting agents"
            if [ -f "$BASE_DIR/logs/agentfield-server.log" ]; then
              echo "=== AgentField Server Logs ==="
              tail -50 "$BASE_DIR/logs/agentfield-server.log"
            fi
            exit 1
          fi

          # Start each agent in background
          echo "Starting summarization_agent..."
          python "$BASE_DIR/agents/summarization_agent.py" > "$BASE_DIR/logs/summarizer.log" 2>&1 &
          SUMMARIZER_PID=$!
          echo "  PID: $SUMMARIZER_PID"
          sleep 3

          echo "Starting planner_agent..."
          python "$BASE_DIR/agents/planner_agent.py" > "$BASE_DIR/logs/planner.log" 2>&1 &
          PLANNER_PID=$!
          echo "  PID: $PLANNER_PID"
          sleep 3

          echo "Starting executor_agent..."
          python "$BASE_DIR/agents/executor_agent.py" > "$BASE_DIR/logs/executor.log" 2>&1 &
          EXECUTOR_PID=$!
          echo "  PID: $EXECUTOR_PID"
          sleep 3

          echo "Starting verifier_agent..."
          python "$BASE_DIR/agents/verifier_agent.py" > "$BASE_DIR/logs/verifier.log" 2>&1 &
          VERIFIER_PID=$!
          echo "  PID: $VERIFIER_PID"
          sleep 3

          echo "Starting generator_agent..."
          python "$BASE_DIR/agents/generator_agent.py" > "$BASE_DIR/logs/generator.log" 2>&1 &
          GENERATOR_PID=$!
          echo "  PID: $GENERATOR_PID"
          sleep 5

          # Check if any agents failed immediately
          echo "Checking agent processes..."
          for pid in $SUMMARIZER_PID $PLANNER_PID $EXECUTOR_PID $VERIFIER_PID $GENERATOR_PID; do
            if ! ps -p $pid > /dev/null 2>&1; then
              echo "âš ï¸ Warning: Process $pid is not running"
            fi
          done

          # Verify agents registered with AgentField
          echo "Checking agent registration..."
          agent_count=$(curl -s http://localhost:8080/api/v1/agents 2>/dev/null | jq '. | length' || echo "0")
          echo "Registered agents: $agent_count/5"

          if [ "$agent_count" -lt "5" ]; then
            echo "âš ï¸ Warning: Only $agent_count/5 agents registered"
            echo ""
            echo "=== Agent Log Previews ==="
            for log in "$BASE_DIR/logs"/{summarizer,planner,executor,verifier,generator}.log; do
              if [ -f "$log" ]; then
                echo "--- $(basename $log) ---"
                head -20 "$log" | tail -10
                echo ""
              fi
            done
          else
            echo "âœ… All 5 agents registered successfully!"
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AGENTFIELD_SERVER: http://localhost:8080
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ” Parse Command
        id: parse_command
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "action=analyze" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer proceed"* ]]; then
            echo "action=proceed" >> $GITHUB_OUTPUT
            # Extract context after "proceed"
            context=$(echo '${{ github.event.comment.body }}' | sed 's/.*@pr-reviewer proceed//g' | xargs)
            echo "context=$context" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer execute"* ]]; then
            echo "action=execute" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer merge"* ]]; then
            echo "action=merge" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.comment.body }}" == *"@pr-reviewer rollback"* ]]; then
            echo "action=rollback" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          else
            echo "action=none" >> $GITHUB_OUTPUT
            echo "context=" >> $GITHUB_OUTPUT
          fi
      
      - name: âš™ï¸ Run PR Review Workflow
        if: steps.parse_command.outputs.action != 'none'
        working-directory: .pr-reviewer
        run: |
          export PYTHONPATH="${{ github.workspace }}/.pr-reviewer:$PYTHONPATH"
          export AGENTFIELD_SERVER="http://localhost:8080"

          # Give agents extra time to fully register (especially for comment-triggered runs)
          echo "Waiting for all agents to be fully ready..."
          sleep 5

          # Pre-flight check: Verify AgentField is still healthy
          echo "Verifying AgentField server health..."
          for i in {1..10}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… AgentField server is healthy (attempt $i)"
              break
            fi
            echo "Attempt $i/10: Server not responding yet..."
            sleep 2
          done

          if ! curl -s http://localhost:8080/health > /dev/null 2>&1; then
            echo "âŒ AgentField server is not responding after 20 seconds"
            echo "Checking server process..."
            if [ -f agentfield.pid ]; then
              SERVER_PID=$(cat agentfield.pid)
              if ps -p $SERVER_PID > /dev/null 2>&1; then
                echo "Server process $SERVER_PID is running but not responding"
              else
                echo "Server process $SERVER_PID is not running"
              fi
            else
              echo "No PID file found"
            fi
            echo "=== Recent server logs ==="
            if [ -f logs/agentfield-server.log ]; then
              tail -50 logs/agentfield-server.log
            else
              echo "No server log file found"
            fi
            echo "=== Directory contents ==="
            ls -la
            exit 1
          fi

          # Check registered agents
          echo "Checking registered agents..."
          agent_list=$(curl -s http://localhost:8080/api/v1/agents 2>/dev/null || echo "[]")
          echo "$agent_list" | jq '.' || echo "Failed to parse agent list"

          agent_count=$(echo "$agent_list" | jq '. | length' 2>/dev/null || echo "0")
          echo "Registered agents: $agent_count"

          if [ "$agent_count" -lt "5" ]; then
            echo "âš ï¸ Warning: Only $agent_count/5 agents are registered"
            echo "Waiting 5 more seconds for agents to register..."
            sleep 5

            agent_count=$(curl -s http://localhost:8080/api/v1/agents 2>/dev/null | jq '. | length' || echo "0")
            echo "After wait: $agent_count/5 agents registered"
          fi

          # Run workflow
          echo "Starting workflow runner..."
          python scripts/github_workflow_runner.py \
            --pr-number ${{ github.event.pull_request.number || github.event.issue.number }} \
            --action ${{ steps.parse_command.outputs.action }} \
            --repo ${{ github.repository }} \
            --context "${{ steps.parse_command.outputs.context }}"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AGENTFIELD_SERVER: http://localhost:8080
      
      - name: ðŸ“Š Upload Agent Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs-${{ github.run_number }}
          path: |
            .pr-reviewer/logs/
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“Š Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: review-results-${{ github.run_number }}
          path: |
            .pr-reviewer/results/
            .pr-reviewer/*.json
          retention-days: 7
          if-no-files-found: ignore

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "Cleaning up processes..."

          # Kill AgentField server
          if [ -f .pr-reviewer/agentfield.pid ]; then
            SERVER_PID=$(cat .pr-reviewer/agentfield.pid)
            if ps -p $SERVER_PID > /dev/null 2>&1; then
              echo "Stopping AgentField server (PID: $SERVER_PID)..."
              kill $SERVER_PID 2>/dev/null || true
            fi
          fi

          # Kill any remaining Python agent processes
          echo "Stopping agent processes..."
          pkill -f "python.*agents.*_agent.py" 2>/dev/null || true

          echo "âœ… Cleanup complete"